# Google Veo 3.1 API Contract Specification
# Date: 2025-11-30
# Purpose: Document Google Veo API endpoints for CLI implementation

openapi: 3.0.0
info:
  title: Google Veo 3.1 Video Generation API
  version: v1beta
  description: API contract for Google's Veo 3.1 video generation service used by veo3 CLI
  contact:
    name: Google AI Platform
    url: https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/video

servers:
  - url: https://generativelanguage.googleapis.com/v1beta
    description: Production API endpoint

security:
  - ApiKeyHeader: []
  - ApiKeyQuery: []

paths:
  /models/{model}:predictLongRunning:
    post:
      operationId: predictLongRunning
      summary: Start video generation operation
      description: Submit a video generation request and receive an operation ID for tracking
      parameters:
        - name: model
          in: path
          required: true
          schema:
            type: string
            enum:
              - veo-3.1-generate-preview
              - veo-3.1-fast-generate-preview
              - veo-3-generate-preview
              - veo-3-fast-generate-preview
              - veo-2.0-generate-001
          description: The Veo model identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PredictRequest'
            examples:
              textToVideo:
                summary: Text-to-video generation
                value:
                  prompt: "A cinematic shot of a majestic lion in the savannah at sunset"
                  negativePrompt: "cartoon, drawing, animated"
                  aspectRatio: "16:9"
                  resolution: "1080p"
                  durationSeconds: "8"
              imageToVideo:
                summary: Image-to-video generation
                value:
                  prompt: "The kitten wakes up and stretches"
                  image:
                    data: "base64_encoded_image_data"
                    mimeType: "image/png"
                  aspectRatio: "16:9"
                  resolution: "720p"
                  durationSeconds: "8"
              interpolation:
                summary: Frame interpolation
                value:
                  prompt: "Smooth transition"
                  image:
                    data: "base64_first_frame"
                    mimeType: "image/jpeg"
                  lastFrame:
                    data: "base64_last_frame"
                    mimeType: "image/jpeg"
                  aspectRatio: "16:9"
                  resolution: "720p"
                  durationSeconds: "8"
              referenceImages:
                summary: Reference image-guided generation
                value:
                  prompt: "A woman walks through a garden"
                  referenceImages:
                    - data: "base64_reference1"
                      mimeType: "image/png"
                    - data: "base64_reference2"
                      mimeType: "image/png"
                  aspectRatio: "16:9"
                  resolution: "720p"
                  durationSeconds: "8"
              extension:
                summary: Video extension
                value:
                  prompt: "The butterfly lands on a flower"
                  video:
                    data: "base64_video_data"
                    mimeType: "video/mp4"
      responses:
        '200':
          description: Operation created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
              example:
                name: "operations/generate/abc123def456"
                metadata:
                  "@type": "type.googleapis.com/google.cloud.aiplatform.v1beta.GenAiTuningServiceMetadata"
                  state: "PENDING"
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidImage:
                  summary: Invalid image format
                  value:
                    error:
                      code: 400
                      message: "Invalid image format. Supported formats: PNG, JPEG, WebP"
                      status: "INVALID_ARGUMENT"
                imageTooLarge:
                  summary: Image exceeds size limit
                  value:
                    error:
                      code: 400
                      message: "Image size exceeds 20MB limit"
                      status: "INVALID_ARGUMENT"
                invalidDuration:
                  summary: Invalid duration for resolution
                  value:
                    error:
                      code: 400
                      message: "1080p resolution only available for 8-second videos"
                      status: "INVALID_ARGUMENT"
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 401
                  message: "API key not valid. Please pass a valid API key."
                  status: "UNAUTHENTICATED"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 429
                  message: "Resource has been exhausted (e.g. check quota)."
                  status: "RESOURCE_EXHAUSTED"
                  details:
                    - retryAfter: "60s"

  /operations/{operationId}:
    get:
      operationId: getOperation
      summary: Get operation status
      description: Poll the status of a long-running video generation operation
      parameters:
        - name: operationId
          in: path
          required: true
          schema:
            type: string
          description: Full operation name (e.g., "operations/generate/abc123")
      responses:
        '200':
          description: Operation status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
              examples:
                pending:
                  summary: Operation pending
                  value:
                    name: "operations/generate/abc123"
                    metadata:
                      "@type": "type.googleapis.com/google.cloud.aiplatform.v1beta.GenAiTuningServiceMetadata"
                      state: "PENDING"
                running:
                  summary: Operation running
                  value:
                    name: "operations/generate/abc123"
                    metadata:
                      "@type": "type.googleapis.com/google.cloud.aiplatform.v1beta.GenAiTuningServiceMetadata"
                      state: "RUNNING"
                      progressPercent: 45
                done:
                  summary: Operation completed
                  value:
                    name: "operations/generate/abc123"
                    metadata:
                      "@type": "type.googleapis.com/google.cloud.aiplatform.v1beta.GenAiTuningServiceMetadata"
                      state: "SUCCEEDED"
                    done: true
                    response:
                      "@type": "type.googleapis.com/google.cloud.aiplatform.v1beta.GenerateVideoResponse"
                      videos:
                        - uri: "https://generativelanguage.googleapis.com/v1beta/files/xyz789"
                          mimeType: "video/mp4"
                failed:
                  summary: Operation failed
                  value:
                    name: "operations/generate/abc123"
                    metadata:
                      "@type": "type.googleapis.com/google.cloud.aiplatform.v1beta.GenAiTuningServiceMetadata"
                      state: "FAILED"
                    done: true
                    error:
                      code: 3
                      message: "Safety filter triggered: violence"
                      details:
                        - "@type": "type.googleapis.com/google.rpc.ErrorInfo"
                          reason: "SAFETY_FILTER_TRIGGERED"
                          metadata:
                            category: "violence"
        '404':
          description: Operation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 404
                  message: "Operation not found"
                  status: "NOT_FOUND"
    
    delete:
      operationId: cancelOperation
      summary: Cancel operation
      description: Cancel a pending or running video generation operation
      parameters:
        - name: operationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Operation cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  done:
                    type: boolean
        '404':
          description: Operation not found

  /files/{fileId}:
    get:
      operationId: downloadFile
      summary: Download generated video
      description: Download the generated video file
      parameters:
        - name: fileId
          in: path
          required: true
          schema:
            type: string
          description: File identifier extracted from video URI
      responses:
        '200':
          description: Video file
          content:
            video/mp4:
              schema:
                type: string
                format: binary
        '404':
          description: File not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error:
                  code: 404
                  message: "File not found or expired (files are retained for 2 days)"
                  status: "NOT_FOUND"

components:
  securitySchemes:
    ApiKeyHeader:
      type: apiKey
      in: header
      name: x-goog-api-key
    ApiKeyQuery:
      type: apiKey
      in: query
      name: key

  schemas:
    PredictRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          maxLength: 1024
          description: Text prompt for video generation
        negativePrompt:
          type: string
          description: Elements to exclude from generation
        image:
          $ref: '#/components/schemas/Image'
          description: First frame for image-to-video or interpolation
        lastFrame:
          $ref: '#/components/schemas/Image'
          description: Last frame for interpolation (requires image)
        referenceImages:
          type: array
          minItems: 1
          maxItems: 3
          items:
            $ref: '#/components/schemas/Image'
          description: Reference images for guided generation (Veo 3.1 only)
        video:
          $ref: '#/components/schemas/Video'
          description: Video to extend (Veo-generated only)
        aspectRatio:
          type: string
          enum: ["16:9", "9:16"]
          default: "16:9"
        resolution:
          type: string
          enum: ["720p", "1080p"]
          default: "720p"
          description: 1080p only valid for 8-second videos
        durationSeconds:
          type: string
          enum: ["4", "6", "8"]
          default: "8"
        personGeneration:
          type: string
          enum: ["allow_all", "allow_adult", "dont_allow"]
          description: Person generation safety filter
        seed:
          type: integer
          description: Random seed for reproducibility

    Image:
      type: object
      required:
        - data
        - mimeType
      properties:
        data:
          type: string
          format: byte
          description: Base64-encoded image data
        mimeType:
          type: string
          enum: ["image/png", "image/jpeg", "image/webp"]
      description: Maximum size 20MB

    Video:
      type: object
      required:
        - data
        - mimeType
      properties:
        data:
          type: string
          format: byte
          description: Base64-encoded video data
        mimeType:
          type: string
          enum: ["video/mp4"]
      description: Maximum duration 141 seconds, Veo-generated only

    OperationResponse:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Operation identifier
          example: "operations/generate/abc123def456"
        metadata:
          type: object
          properties:
            "@type":
              type: string
            state:
              type: string
              enum: ["PENDING", "RUNNING", "SUCCEEDED", "FAILED", "CANCELLED"]
            progressPercent:
              type: number
              minimum: 0
              maximum: 100
        done:
          type: boolean
          description: True when operation completed (success or failure)
        response:
          type: object
          description: Present when done=true and successful
          properties:
            "@type":
              type: string
            videos:
              type: array
              items:
                type: object
                properties:
                  uri:
                    type: string
                    description: Download URL for generated video
                  mimeType:
                    type: string
        error:
          type: object
          description: Present when done=true and failed
          properties:
            code:
              type: integer
            message:
              type: string
            details:
              type: array
              items:
                type: object

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
            - status
          properties:
            code:
              type: integer
              description: HTTP status code
            message:
              type: string
              description: Human-readable error message
            status:
              type: string
              description: gRPC status code
              enum:
                - INVALID_ARGUMENT
                - UNAUTHENTICATED
                - PERMISSION_DENIED
                - NOT_FOUND
                - RESOURCE_EXHAUSTED
                - INTERNAL
            details:
              type: array
              items:
                type: object
              description: Additional error context

# CLI-Specific Contract Notes:
# 
# Authentication:
#   - API key provided via x-goog-api-key header
#   - No OAuth2 support in CLI (API key only)
#   - API key sourced from: --api-key flag > GEMINI_API_KEY env > config file
#
# Polling Strategy:
#   - Poll /operations/{id} every 10 seconds (configurable)
#   - Exponential backoff: 10s → 20s → 40s → max 60s
#   - Timeout: 6 minutes (API max latency per spec)
#   - Cancellable via context (Ctrl+C)
#
# File Encoding:
#   - Images/videos base64-encoded before upload
#   - Videos base64-decoded after download
#   - Streaming download for large files (avoid memory issues)
#
# Error Handling:
#   - Safety filter errors: Display category, suggest prompt revision
#   - Rate limits: Display retry-after, offer to queue
#   - Authentication errors: Guide to config setup
#   - File errors: Validate format/size before API call
#
# Model Constraints (enforced client-side):
#   - Reference images: Veo 3.1 only, 8s, 16:9
#   - Extension: Veo 3.1/3.0 only, max 141s input
#   - 1080p: 8-second videos only
#   - Audio: All models except 2.0
#
# Validation Order:
#   1. Client-side validation (file exists, size, format)
#   2. Model constraint validation (features available)
#   3. API submission
#   4. Server-side validation (safety, technical feasibility)